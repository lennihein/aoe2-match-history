<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ player_name }} - AoE2 Scout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Dark Mode">
        <span class="icon">üåô</span>
    </button>
    <div class="bg-gradient"></div>
    <div class="container">
        <header class="profile-header">
            <div>
                <a href="/" class="back-link">‚Üê Back to Search</a>
                <h1 style="font-size: 2.5rem; text-align: left; margin-top: 1rem;">{{ player_name }}</h1>
                <p class="subtitle">Insights ID: {{ user_id }}</p>
            </div>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshProfile('{{ user_id }}')">
                <span id="refreshIcon">üîÑ</span>
                <span id="refreshText">Refresh Data</span>
            </button>
        </header>
        {% if fetch_status and not fetch_status.is_complete %}
        <div class="warning-banner">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-content">
                <strong>Partial History Loaded</strong>
                <p>The match history for this player is too large to load fully in one go. Some older matches might be
                    missing.</p>
                <button class="resume-btn" id="backfillBtn" onclick="loadOlderHistory('{{ user_id }}')">
                    <span id="backfillIcon">üì•</span>
                    <span id="backfillText">Load Older History</span>
                </button>
            </div>
        </div>
        {% endif %}

        <div id="live-stats">
            {% include 'player_content.html' %}
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
        async function refreshProfile(userId) {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            const text = document.getElementById('refreshText');

            btn.disabled = true;
            icon.classList.add('spinning');
            text.textContent = 'Refreshing...';

            try {
                const response = await fetch(`/user/${userId}/refresh`, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                alert('Failed to refresh data.');
            } finally {
                btn.disabled = false;
                icon.classList.remove('spinning');
                text.textContent = 'Refresh Data';
            }
        }

        async function loadOlderHistory(userId) {
            const btn = document.getElementById('backfillBtn');
            const icon = document.getElementById('backfillIcon');
            const text = document.getElementById('backfillText');

            btn.disabled = true;
            icon.classList.add('spinning');
            text.textContent = 'Starting...';

            try {
                const response = await fetch(`/user/${userId}/backfill`, { method: 'POST' });
                const data = await response.json();

                if (response.status === 202) {
                    // Started successfully
                    pollBackfillStatus(userId);
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                    btn.disabled = false;
                    icon.classList.remove('spinning');
                    text.textContent = 'Load Older History';
                }
            } catch (err) {
                alert('Failed to load older data.');
                btn.disabled = false;
                icon.classList.remove('spinning');
                text.textContent = 'Load Older History';
            }
        }

        let lastMatchCount = 0;

        async function updateStats(userId) {
            try {
                const response = await fetch(`/user/${userId}/stats_partial`);
                if (response.ok) {
                    const html = await response.text();
                    const container = document.getElementById('live-stats');
                    if (container) {
                        container.innerHTML = html;
                    }
                }
            } catch (err) {
                console.error("Failed to update stats partial", err);
            }
        }

        async function pollBackfillStatus(userId) {
            const btn = document.getElementById('backfillBtn');
            const icon = document.getElementById('backfillIcon');
            const text = document.getElementById('backfillText');

            // Ensure button is in loading state
            if (btn) {
                btn.disabled = true;
                icon.classList.add('spinning');
            }

            try {
                const response = await fetch(`/user/${userId}/backfill/status`);
                const data = await response.json();

                if (data.status === 'running') {
                    if (text) text.textContent = `Loading... (Page ${data.page})`;

                    // Check if we have new data to show
                    if (data.count > lastMatchCount) {
                        lastMatchCount = data.count;
                        updateStats(userId);
                    }

                    // Poll again in 2 seconds
                    setTimeout(() => pollBackfillStatus(userId), 2000);
                } else if (data.status === 'finished') {
                    if (text) text.textContent = 'Completed!';
                    window.location.reload();
                } else if (data.status === 'error') {
                    alert('Backfill failed: ' + data.message);
                    if (btn) btn.disabled = false;
                    if (icon) icon.classList.remove('spinning');
                    if (text) text.textContent = 'Load Older History';
                } else {
                    // Not running (stopped or unknown)
                    if (btn) btn.disabled = false;
                    if (icon) icon.classList.remove('spinning');
                    if (text) text.textContent = 'Load Older History';
                }
            } catch (err) {
                console.error('Polling error', err);
                // Retry anyway
                setTimeout(() => pollBackfillStatus(userId), 2000);
            }
        }

        // Check status on page load in case a job is already running
        document.addEventListener('DOMContentLoaded', () => {
            // userId is available from the template context, but we need it in JS.
            // We can extract it from the URL or the template.
            // The template renders refreshProfile('{{ user_id }}'), so we can grab it from there or cleaner way.
            // Let's assume user_id is passed as string in the variable `currentUserId`.
            // We'll add a script tag to define it.
            if (typeof currentUserId !== 'undefined') {
                checkInitialStatus(currentUserId);
            }
        });

        async function checkInitialStatus(userId) {
             try {
                const response = await fetch(`/user/${userId}/backfill/status`);
                const data = await response.json();
                if (data.status === 'running') {
                    pollBackfillStatus(userId);
                }
            } catch (e) {
                console.log("Could not check initial status", e);
            }
        }
    </script>
    <script>
        const currentUserId = "{{ user_id }}";
    </script>
</body>

</html>